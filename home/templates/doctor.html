{% extends 'base.html'%}
<!DOCTYPE html>
<html lang="ru">
  <head>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заголовок страницы</title>
    <link rel="stylesheet" href="./styles/style.css">
		<style>
			#loading {
				position: fixed;
				top: 50%;
				left: 50%;
				width: 6rem;
				height: 6rem;
				z-index: 9999; /* Устанавливаем высокий z-index, чтобы элемент был поверх всех других */
				background-color: rgba(255, 255, 255, 0.8); /* Прозрачный фон */
				padding: 20px;
			}
		</style>
  </head>
  <body class="flex-column h-100">
  {% block content %}  
		<div class="main-index">

			<div class="container py-3 border-bottom main-index-current-task">
				<div
					id="loading"
					class="text-center sticky-top spinner-border text-primary"
					role="status"
					style="display: none"
				>
					<span class="visually-hidden sr-only">Загрузка...</span>
				</div>
				<div class="row">
					<div class="col">
						<h3 class="container display-10 fw-bold text-left p-0">
							Текущие задачи
						</h3>
					</div>
					<div class="col-6">
						<div class="form-check form-switch">
							<input
								class="form-check-input"
								type="checkbox"
								role="switch"
								id="TableTask"
							/>
							<label class="form-check-label" for="TableTask"
								>Переключить содержимое таблицы (Диабет)</label
							>
						</div>
					</div>
				</div>

				<div class="scroll-table-body">
					<table
						id="patients_with_dy"
						class="table-group-divider zz w-100 table table-striped-columns"
					>
						<thead>
							<tr>
								<th scope="col" class="col-2 text-center">Больница</th>
								<th scope="col" class="col-2 text-center">Фамилия</th>
								<th scope="col" class="col-2 text-center">Имя</th>
								<th scope="col" class="col-2 text-center">Отчество</th>
								<th scope="col" class="col-2 text-center">
									Дата приема
									<a href="#" onclick="sortTableByDate1()">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="16"
											height="16"
											fill="currentColor"
											class="bi bi-filter"
											viewBox="0 0 16 16"
										>
											<path
												d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"
											/>
										</svg>
									</a>
								</th>
								<th scope="col" class="col-1 text-center">Вероятность</th>
							</tr>
						</thead>
						<tbody class="table-group-divider" id="p_with_dy">
							{% for app in patients_with_diabetes %}
									{% if app.score >= 0.9 %}
										<tr
											onclick="window.location.href='{% url 'get_appointment' app.patient.id %}'; return false"
											class="user-danger"
										>
											<td scope="col-2" class="text-center">
												{{ app.patient.locations }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.first_name }}
											</td>
											<td scope="col-2" class="text-center">{{ app.patient.surname }}</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.patronymic }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.date|date:"d-m-Y" }}
											</td>
											<td scope="col" class="text-center">
												{{ app.score|floatformat:"-2" }}
											</td>
										</tr>
									{% elif 0.9 > app.score and app.score >= 0.55 %}
										<tr
											onclick="window.location.href='{% url 'get_appointment' app.patient.id %}'; return false"
											class="user-warning"
										>
											<td scope="col-2" class="text-center">
												{{ app.patient.locations }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.first_name }}
											</td>
											<td scope="col-2" class="text-center">{{ app.patient.surname }}</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.patronymic }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.date|date:"d-m-Y" }}
											</td>
											<td scope="col" class="text-center">
												{{ app.score|floatformat:"-2" }}
											</td>
										</tr>
									{% else %}
										<tr
											onclick="window.location.href='{% url 'get_appointment' app.patient.id %}'; return false"
											class="table-info"
										>
											<td scope="col-2" class="text-center">
												{{ app.patient.locations }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.first_name }}
											</td>
											<td scope="col-2" class="text-center">{{ app.patient.surname }}</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.patronymic }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.date|date:"d-m-Y" }}
											</td>
											<td scope="col" class="text-center">Норма</td>
										</tr>
									{% endif %} 
							{% endfor %}
						</tbody>
						<tbody
							class="table-group-divider"
							id="p_without_dy"
							style="display: none"
						>
							{% for app in patients_without_diabetes %} 
									{% if app.score >= 0.9 %}
										<tr
											onclick="window.location.href='{% url 'get_appointment' app.patient.id %}'; return false"
											class="user-danger"
										>
											<td scope="col-2" class="text-center">
												{{ app.patient.locations }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.first_name }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.surname }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.patronymic }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.date|date:"d-m-Y" }}
											</td>
											<td scope="col" class="text-center">
												{{ app.score|floatformat:"-2" }}
											</td>
										</tr>
									{% elif 0.9 > app.score and app.score >= 0.55 %}
										<tr
											onclick="window.location.href='{% url 'get_appointment' app.patient.id %}'; return false"
											class="user-warning"
										>
											<td scope="col-2" class="text-center">
												{{ app.patient.locations }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.first_name }}
											</td>
											<td scope="col-2" class="text-center">{{ app.patient.surname }}</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.patronymic }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.date|date:"d-m-Y" }}
											</td>
											<td scope="col" class="text-center">
												{{ app.score|floatformat:"-2" }}
											</td>
										</tr>
									{% else %}
										<tr
											onclick="window.location.href='{% url 'get_appointment' app.patient.id %}'; return false"
											class="table-info"
										>
											<td scope="col-2" class="text-center">
												{{ app.patient.locations }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.first_name }}
											</td>
											<td scope="col-2" class="text-center">{{ app.patient.surname }}</td>
											<td scope="col-2" class="text-center">
												{{ app.patient.patronymic }}
											</td>
											<td scope="col-2" class="text-center">
												{{ app.date|date:"d-m-Y" }}
											</td>
											<td scope="col" class="text-center">Норма</td>
										</tr>
									{% endif %} 	
							{% endfor %}
						</tbody>
					</table>
				</div>

				<form
					id="download_excel"
					method="POST"
					action="{% url 'download_excel' %}"
					enctype="multipart/form-data"
				>
					{% csrf_token %}
					<div class="row">
						<div class="col">
							<h3 class="container display-10 fw-bold text-left p-0">
								Список пациентов для выгрузки
							</h3>
						</div>
						<div class="col">
							<button
								type="submit"
								class="btn appointment-button"
								id="download-excel-btn"
							>
								Выгрузить excel файл
							</button>
						</div>
						<div class="col-6">
							<div class="form-check form-switch">
								<input
									class="form-check-input"
									type="checkbox"
									role="switch"
									id="TableList"
								/>
								<label class="form-check-label" for="TableList"
									>Переключить содержимое таблицы (Диабет)</label
								>
							</div>
						</div>
					</div>
					<div class="scroll-table-body">
						<table
							id="patients_with_dg"
							class="table-group-divider zz w-100 table table-striped-columns"
						>
							<thead>
								<tr>
									<th
										scope="col"
										class="col-1 text-center"
										id="select-all-checkbox"
									>
										<input type="checkbox" class="form-check-input" />
									</th>
									<th scope="col" class="col-2 text-center">Больница</th>
									<th scope="col" class="col-2 text-center">Фамилия</th>
									<th scope="col" class="col-2 text-center">Имя</th>
									<th scope="col" class="col-2 text-center">Отчество</th>
									<th scope="col" class="col-2 text-center">
										Дата приема
										<a href="#" onclick="sortTableByDate2()">
											<svg
												xmlns="http://www.w3.org/2000/svg"
												width="16"
												height="16"
												fill="currentColor"
												class="bi bi-filter"
												viewBox="0 0 16 16"
											>
												<path
													d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"
												/>
											</svg>
										</a>
									</th>
									<th scope="col" class="col-1 text-center">Вероятность</th>
								</tr>
							</thead>
							<tbody class="table-group-divider" id="p_with_dg">
								{% for appointment in export_p_d %} 
									<tr onclick="toggleCheckbox(this)" class="user-danger">
										<td scope="col" class="col text-center qwe" style="width: 5%">
											<input
												type="checkbox"
												class="form-check-input qwe patient-checkbox"
												name="selected_patients"
												value="{{ appointment.id }}"
												onclick="event.stopPropagation()"
												id="flexCheckChecked"
											/>
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.locations }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.first_name }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.surname }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.patronymic }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.date|date:"d-m-Y" }}
										</td>
										<td scope="col" class="text-center">
											{{ appointment.score|floatformat:"-2" }}
										</td>
									</tr>
								{% endfor %}
							</tbody>
							<tbody
								class="table-group-divider"
								id="p_without_dg"
								style="display: none"
							>
								{% for appointment in export_no_d %} 
									<tr onclick="toggleCheckbox(this)" class="user-danger">
										<td scope="col" class="col text-center qwe" style="width: 5%">
											<input
												type="checkbox"
												class="form-check-input qwe patient-checkbox"
												name="selected_patients"
												value="{{ appointment.id }}"
												onclick="event.stopPropagation()"
												id="flexCheckChecked"
											/>
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.locations }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.first_name }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.surname }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.patient.patronymic }}
										</td>
										<td scope="col-2" class="text-center">
											{{ appointment.date|date:"d-m-Y" }}
										</td>
										<td scope="col" class="text-center">
											{{ appointment.score|floatformat:"-2" }}
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</form>
				<script>
					document
						.getElementById('TableList')
						.addEventListener('click', function () {
							var checkboxes = document.querySelectorAll(
								"#patients_with_dg input[type='checkbox']"
							)
							for (var i = 0; i < checkboxes.length; i++) {
								checkboxes[i].checked = this.checked
							}
						})
					document
						.getElementById('select-all-checkbox')
						.addEventListener('click', function () {
							var checkboxes = document.querySelectorAll('.patient-checkbox')
							for (var i = 0; i < checkboxes.length; i++) {
								checkboxes[i].checked = !checkboxes[i].checked
							}
						})
				</script>
				<script>
					function toggleCheckbox(row) {
						var checkbox = row.querySelector('input[type="checkbox"]')
						checkbox.checked = !checkbox.checked
					}

					document
						.getElementById('TableTask')
						.addEventListener('click', function () {
							var t_patientsWithDiabetes = document.getElementById('p_with_dy')
							var t_patientsWithoutDiabetes =
								document.getElementById('p_without_dy')
							var t_label = document.querySelector("label[for='TableTask']")

							if (this.checked) {
								t_patientsWithDiabetes.style.display = 'none'
								t_patientsWithoutDiabetes.style.display = ''
								t_label.innerText =
									'Переключить содержимое таблицы (Без диабета)'
							} else {
								t_patientsWithDiabetes.style.display = ''
								t_patientsWithoutDiabetes.style.display = 'none'
								t_label.innerText = 'Переключить содержимое таблицы (Диабет)'
							}
						})

					document
						.getElementById('TableList')
						.addEventListener('click', function () {
							var l_patientsWithDiabetes = document.getElementById('p_with_dg')
							var l_patientsWithoutDiabetes =
								document.getElementById('p_without_dg')
							var l_label = document.querySelector("label[for='TableList']")

							if (this.checked) {
								l_patientsWithDiabetes.style.display = 'none'
								l_patientsWithoutDiabetes.style.display = ''
								l_label.innerText =
									'Переключить содержимое таблицы (Без диабета)'
							} else {
								l_patientsWithDiabetes.style.display = ''
								l_patientsWithoutDiabetes.style.display = 'none'
								l_label.innerText = 'Переключить содержимое таблицы (Диабет)'
							}
						})
				</script>
				<div class="row">
					<div class="col">
						<h3 class="display-10 fw-bold text-center">
							Просмотреть готовые анкеты пациентов
						</h3>
					</div>
				</div>
				<div class="row g-3 align-items-center">
					<div class="col-7">
						<input
							type="text"
							id="searchInput"
							class="form-control"
							placeholder="Поиск по Фамилии, Имени или Отчеству"
						/>
					</div>
					<div class="col-5 text-right">
						<div class="form-check form-switch">
							<input
								class="form-check-input"
								type="checkbox"
								role="switch"
								id="pathology_filter"
								name="filter"
								value="pathology"
								checked
							/>
							<label class="form-check-label" for="pathology_filter"
								>Показать только пациентов с патологией</label
							>
						</div>
					</div>
				</div>
				<br />
				<div id="patient-table-container">

					<table
						id="check_patients"
						class="table-group-divider zz w-100 table table-striped-columns"
					>
						<thead>
							<tr>
									<th scope="col" class="col-3 text-center">
										<input type="text" id="hospital-filter" placeholder="Больница" />
									</th>
									<th scope="col" class="col-2 text-center">
											<input type="text" id="first-name-filter" placeholder="Фамилия" />
									</th>
									<th scope="col" class="col-2 text-center">
											<input type="text" id="surname-filter" placeholder="Имя" />
									</th>
									<th scope="col" class="col-2 text-center">
											<input type="text" id="patronymic-filter" placeholder="Отчество" />
									</th>
									<th scope="col" class="col-2 text-center">Дата приема</th>
							</tr>
						</thead>
						<tbody class="table-group-divider" id="check_pathology_1">

						</tbody>
					</table>

					<div class="pagination">
							<span class="step-links">
									<button id="prev-page" disabled>Предыдущая</button>
									<span id="current-page">Страница 1 из ?.</span>
									<button id="next-page">Следующая</button>
							</span>
					</div>
				</div>

				<script>
						let currentPage = 1;

						function loadPatients(page, filters = {}) {

								$.ajax({
										url: '/patients/?page=' + page,
										type: 'GET',
										dataType: 'json',
										data: filters,
										success: function(data) {
												const tbody = $('#check_pathology_1');
												tbody.empty(); // Очищаем старые данные

												data.patients.forEach(patient => {
														const patientRow = document.createElement('tr');
														patientRow.classList.add('table-info');
														patientRow.setAttribute('data-patient-id', patient.id);
														
														patientRow.innerHTML = `
																<td class="text-center">${patient.hospital}</td>
																<td class="text-center">${patient.first_name}</td>
																<td class="text-center">${patient.surname}</td>
																<td class="text-center">${patient.patronymic}</td>
																<td class="text-center">${patient.appointment_last}</td>`
														
														patientRow.addEventListener('click', () => {
																window.location.href = `/get_appointment${patient.id}/old_appointment`
														});

														tbody.append(patientRow);
												});
												currentPage = data.current_page;

												$('#prev-page').prop('disabled', !data.has_previous);
												$('#next-page').prop('disabled', !data.has_next);
										}
								});
						}

						$('#prev-page').on('click', function() {
								if (currentPage > 1) {
										loadPatients(currentPage - 1);
								}
						});

						$('#next-page').on('click', function() {
								loadPatients(currentPage + 1);
						});

						$(document).ready(function() {
								loadPatients(1);

								// Обработчики событий для фильтров
								$('#pathology_filter, #hospital-filter, #surname-filter, #first-name-filter, #patronymic-filter').on('input', function() {
										loadPatients(1, getFilters());
								});
						});

						function getFilters() {
								return {
										pathology: $('#pathology_filter').val(),
										hospital: $('#hospital-filter').val(),
										surname: $('#surname-filter').val(),
										first_name: $('#first-name-filter').val(),
										patronymic: $('#patronymic-filter').val()
								};
						}

				</script>

				<script>

					function toggleCollapsible(id) {
						var collapsible = document.getElementById('collapse' + id)
						if (collapsible.style.display === 'none') {
							collapsible.style.display = ''
						} else {
							collapsible.style.display = 'none'
						}
					}
				</script>
				<script>
					$(document).ready(function () {
						$('#searchInput').on('keyup', function () {
							var value = $(this).val().toLowerCase()
							$('#check_patients tbody tr').filter(function () {
								$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
							})
						})
					})

					const flexSwitch = document.getElementById('flexSwitch')
					const check_pathology_1 = document.getElementById('check_pathology_1')
					const check_all_1 = document.getElementById('check_all_1')

					flexSwitch.addEventListener('change', function () {
						if (flexSwitch.checked) {
							check_pathology_1.style.display = ''
							check_all_1.style.display = 'none'
						} else {
							check_pathology_1.style.display = 'none'
							check_all_1.style.display = ''
						}
					})
				</script>
			</div>
		</div>
		<!--      # TODO: Загрузка   -->

		<script>
			// Показываем Border spinner перед переходом на новую страницу
			$(document).ready(function () {
				$('#patients_with_dy tr').click(function () {
					$('#loading').fadeIn()
					$('#patients_with_dy tr').attr('disabled', true)
				})
			})
		</script>
		<script src="{% static 'js/table_select.js' %}"></script>
		<script src="{% static 'js/sort_table_gd.js' %}"></script>
		<script src="{% static 'js/sort_table_check.js' %}"></script>
		<script src="{% static 'js/jquery.dataTables.min.js' %}"></script>
		<script src="{% static 'js/moment.min.js' %}"></script>
		<script src="{% static 'js/dataTables.dateTime.min.js' %}"></script>
		<script src="{% static 'js/datatable_patient.js' %}"></script>
		<script src="{% static 'js/sort_table_doctor.js' %}"></script>
		<script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>

  {% endblock %}
  </body>
</html>